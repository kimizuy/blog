import result from './result.png'

export const meta = {
  title: 'Github Actions で画像最適化を自動化する',
  description:
    'またも GitHub Actions。今回はプルリクエスト作成時に自動で画像の最適化・圧縮する方法をまとめる。かなりお手軽',
  date: { published: '2020-08-26' },
  tags: ['github'],
  image: result,
}

またも GitHub Actions。今回はプルリクエスト作成時に自動で画像の最適化・圧縮する方法をまとめる。かなりお手軽。

# Github Actions の設定ファイルを追加する

プロジェクトのルートに以下の内容のファイルを追加する。

`./github/workflows/optimize-images.yml`

```yml
name: Optimize images
on: pull_request
jobs:
  build:
    name: calibreapp/image-actions
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repo
        uses: actions/checkout@master

      - name: Compress Images
        uses: calibreapp/image-actions@master
        with:
          githubToken: ${{ secrets.GITHUB_TOKEN }}
```

また、画像の種類ごとに圧縮率をカスタマイズできる（デフォルト値はいずれも 80）

[image-quality-settings](https://github.com/calibreapp/image-actions#image-quality-settings)

```yml
~~~
- name: Compress Images
  uses: calibreapp/image-actions@master
  with:
    githubToken: ${{ secrets.GITHUB_TOKEN }}
    jpegQuality: '80'
    jpegProgressive: false
    pngQuality: '80'
    webpQuality: '80'
    ignorePaths: 'node_modules/**,build'
    # No spaces allowed
```

`jpegProgressive` は jpeg ファイルをプログレッシブ形式に変換するかどうか。プログレッシブ形式については[こちら](https://naifix.com/jpeg/)。jpeg はベースラインとプログレッシブの二種類あるのか。へぇー。

# 実際にプルリクエストを作成する

master に対してプルリクエストを作成すると GitHub Action が実行され少し待って以下のような結果が表示される。

<img src={result} />

注意点として、このアクションが実行されるとプルリクエストに最適化された画像が再度コミットされること。master ← dev のようなプルリクエストの場合、dev ブランチで差分が生じるので混乱しないようにしたい。

# 参考

[calibreapp/image-actions](https://github.com/calibreapp/image-actions)

[Optimize Images with a GitHub Action](https://css-tricks.com/optimize-images-with-a-github-action/)
